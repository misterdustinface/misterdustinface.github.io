<!doctype>
<html>
	<head>
		<style>
		#canvas{
			background: #000;
		}
		</style>
	</head>
	<body>
		
		<canvas id="canvas" width="640" height="360"></canvas>
		
	</body>
</html>

<script>

///////////////////////////////////////////////////////

window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.msRequestAnimationFrame;
window.onload = function(){
	window.addEventListener("keydown", keyDownEventHandler, false);
	window.addEventListener("keyup",   keyUpEventHandler, false);
};
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");
ctx.font = "bold 16px Monospace";
var FPS = 30;
setInterval(gameLoop, 1000/FPS);

var WINNING_SCORE = 10;
var LEFT_SCORE    = 0;
var RIGHT_SCORE   = 0;
var LEFT_WIN      = false;
var RIGHT_WIN     = false;

var MAX_PADDLE_SPEED = 10;

//////////////////////////////////////////////////////////////////////////
function gameLoop(){
	update();
	draw();
}

function update(){
	updatePaddles();
	updateBall();
	checkWin();
	if(shouldResetGame()) {
		resetGameData();
	}
}

function draw(){
	clearCanvas();
	drawBall();
	drawPaddle(LeftPaddle);
	drawPaddle(RightPaddle);
	drawTextInfo();
}

function clearCanvas() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
}

function drawBall() {
	ctx.fillStyle = Ball.color;
	ctx.beginPath();
	ctx.arc(Ball.x - Ball.size/2, Ball.y - Ball.size/2, Ball.size, 0, 2*Math.PI, false);
	ctx.fill();
}

function drawPaddle(paddle) {
	ctx.beginPath();
	ctx.fillStyle = paddle.color;
	ctx.rect(paddle.x, paddle.y, paddle.width, paddle.height);
	ctx.fill();
}

var SCOREFIELD_LENGTH = ctx.measureText("XX [Score] XX").width;
var PROMPT_BALL_SERVE_TEXT = "PRESS [SPACE]";
var PROMPT_BAlL_SERVE_TEXT_LENGTH = ctx.measureText(PROMPT_BALL_SERVE_TEXT).width;
function drawTextInfo() {
	ctx.fillStyle = "#777";
	ctx.fillText(LEFT_SCORE + " [Score] " + RIGHT_SCORE, canvas.width/2 - (SCOREFIELD_LENGTH/2), 20);
	if(!Ball.served) {
    		ctx.fillText(PROMPT_BALL_SERVE_TEXT, canvas.width/2 - (PROMPT_BAlL_SERVE_TEXT_LENGTH/2), 200);
	}
  	if(RIGHT_WIN || LEFT_WIN) {
  		var winnerText = (RIGHT_WIN ? "RIGHT WINS" : "LEFT WINS"); 
  		var length = ctx.measureText(winnerText).width;
		ctx.fillText(winnerText, canvas.width/2 - (length/2), 250);
  	}
}

function drawMouse() {
	ctx.fillStyle = "#e3e";
	ctx.beginPath();
	ctx.arc(Mouse.x, Mouse.y, 2, 0, 2*Math.PI, false);
	ctx.fill();
}

///////////////////////////////////////////////////////////////////
var W		= 87;
var S		= 83;
var UP_ARROW	= 38;
var DOWN_ARROW	= 40;
var SPACEBAR	= 32;

function keyDownEventHandler(e){
	if(e.keyCode == SPACEBAR)
		serveBall();
	
	if(e.keyCode == W)
		LeftPaddle.up = true;
	if(e.keyCode == S)
		LeftPaddle.down = true;
	if(e.keyCode == UP_ARROW)
		RightPaddle.up = true;
	if(e.keyCode == DOWN_ARROW)
		RightPaddle.down = true;
}

function keyUpEventHandler(e){

  	if(e.keyCode == W)
		LeftPaddle.up = false;
	if(e.keyCode == S)
		LeftPaddle.down = false;
	if(e.keyCode == UP_ARROW)
		RightPaddle.up = false;
	if(e.keyCode == DOWN_ARROW)
		RightPaddle.down = false;
}

///////////////////////////////////////////////////////////////////
// MOUSE	
var Mouse = {
	x: canvas.width/2,
	y: canvas.height/2,
};
canvas.onmousemove = function(event){	
	Mouse.x = event.clientX;
	Mouse.y = event.clientY;
};
canvas.onmousedown = function(){
};
canvas.onmouseup = function(){
};

///////////////////////////////////////////////////////////////////
var LeftPaddle = {
	x: 20,
	y: canvas.height/2,
	width: 4,
	height: 64,
	yVel: 0,
	speed: 2,
	color: "#fff",
	up: false,
	down: false,
};
var RightPaddle = {
	x: canvas.width - 20,
	y: canvas.height/2,
	width: 4,
	height: 64,
	yVel: 0,
	speed: 2,
	color: "#fff",
	up: false,
	down: false,
};

var Ball = {
	x: canvas.width/2,
	y: canvas.height/2,
	yVel: 0,
	xVel: 0,
	size: 4,
	speed: 10,
	served: false,
	color: "#fff"
};

function updatePaddles(){
  applyControllerCommandToPaddle(LeftPaddle);
  limitPaddleSpeed(LeftPaddle);
  keepPaddleInBounds(LeftPaddle);
  
  applyControllerCommandToPaddle(RightPaddle);
  limitPaddleSpeed(RightPaddle);
  keepPaddleInBounds(RightPaddle);
}

function applyControllerCommandToPaddle(paddle) {
  if(paddle.up ^ paddle.down) {
  	if(paddle.up) 	paddle.yVel -= paddle.speed;
  	if(paddle.down)	paddle.yVel += paddle.speed;
  	paddle.y += paddle.yVel // move y position accordingly
  } else {
  	paddle.yVel *= 1/4.0;
  	paddle.y += paddle.yVel // move y position accordingly
  	//paddle.yVel = 0;
  }

}

function limitPaddleSpeed(paddle){
  	if(paddle.yVel > MAX_PADDLE_SPEED)
		paddle.yVel = MAX_PADDLE_SPEED;
	if(paddle.yVel < -MAX_PADDLE_SPEED)
		paddle.yVel = -MAX_PADDLE_SPEED;
}

function keepPaddleInBounds(paddle){
	if(paddle.y + paddle.height < 0)
		paddle.y = canvas.height;
	else if(paddle.y > canvas.height)
		paddle.y = -paddle.height;
}

// TODO - give the loser the ball to serve and have it serve from their paddle
function serveBall(){
	if(! Ball.served){
		Ball.xVel = Math.random() * Ball.speed;
		Ball.yVel = Math.random() * Ball.speed;
		if(Math.random() > 0.5)
			Ball.xVel = -Ball.xVel;
		if(Math.random() > 0.5)
			Ball.yVel = -Ball.yVel;
		if(Math.abs(Ball.yVel) > Math.abs(Ball.xVel))
			Ball.xVel = Ball.yVel;
		Ball.served = true;
	}
}

function updateBall(){
	Ball.x += Ball.xVel;
	Ball.y += Ball.yVel;
	
	if(Ball.x <= LeftPaddle.x + LeftPaddle.width && Ball.y > LeftPaddle.y && Ball.y < LeftPaddle.y + LeftPaddle.height)
		swatBall();
	if(Ball.x >= RightPaddle.x && Ball.y > RightPaddle.y && Ball.y < RightPaddle.y + RightPaddle.height)
		swatBall();
	
	keepBallInBounds();
}

// TODO - pass in paddle so we can make the swat based on the paddle and ball velocity vectors
function swatBall(){
	Ball.xVel = -Ball.xVel;
	if(Ball.xVel < 0)
		Ball.xVel -= Math.random() * Ball.speed;
	else
		Ball.xVel += Math.random() * Ball.speed;
	Ball.yVel = Math.random() * Ball.speed;
	if(Math.random() > 0.5)
		Ball.yVel = -Ball.yVel;
}

function keepBallInBounds(){
	if(Ball.y > canvas.height || Ball.y < 0)
		Ball.yVel = -Ball.yVel;
	
	if(Ball.x > canvas.width){
		LEFT_SCORE += 1;
		resetBall();
	}
	if(Ball.x < 0){
		RIGHT_SCORE += 1;
		resetBall();
	}
}

function checkWin(){
	if(RIGHT_SCORE >= WINNING_SCORE) RIGHT_WIN = true;
	if(LEFT_SCORE  >= WINNING_SCORE) LEFT_WIN  = true;
}

function resetBall(){
	Ball.x = canvas.width/2;
	Ball.y = canvas.height/2;
	Ball.xVel = 0;
	Ball.yVel = 0;
	Ball.served = false;
}

function shouldResetGame() {
  return (RIGHT_WIN || LEFT_WIN) && (Ball.served);
}

function resetGameData(){
  RIGHT_WIN = false;
  LEFT_WIN = false;
  RIGHT_SCORE = 0;
  LEFT_SCORE = 0;
}

</script>
